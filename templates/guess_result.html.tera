<!DOCTYPE html>
<html>
  <head>
    <title>Street View Containers</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key={{api_key}}&callback=initialize&libraries=&v=weekly"
      defer
    ></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap-theme.min.css" integrity="sha384-6pzBo3FDv/PJ8r2KRkGHifhEocL+1X2rVCTTkUfGk7/0pbek5mMa1upzvWbrUbOZ" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
    <style type="text/css">
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #map {
        position: absolute;
        width: 100%;
        height: 100%;
        /*z-index: 100;*/
      }

      #next {
        position: absolute;
        z-index: 100;
        margin-left: auto;
        margin-right: auto;
        width: 400px;
        left: 0;
        right: 0;
        top: 10px;
      }

      #results {
        position: absolute;
        z-index: 100;
        width: 200px;
        right: 0px;
        background: white;
      }
    </style>
    <script>
      let map;
      let actual;
      let guess;
      let diff_line;

      function pollGame() {
        $.get("game-poller", {}, function(data) {
            console.log(data);
            let playerid = Cookies.get("playerid");
            if (data.player_states[playerid] === "Guessing") {
                // Move to the new screen
                window.location.replace("play-round");
            } else if (data.player_states[playerid] === "RoundResults") {
                // The game is over, finish up
            } else {
                setTimeout(function() { pollGame(); }, 500);
            }
        }, "json");
      }

      function initialize() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 0, lng: 0 },
          zoom: 8,
        });
        let actual_pos = { lat: {{result.actual.latitude}}, lng: {{result.actual.longitude}} };
        let guess_pos = { lat: {{result.guess.latitude}}, lng: {{result.guess.longitude}} };
        actual = new google.maps.Marker({
            position: actual_pos,
            label: "ACTUAL",
            map,
        });
        guess = new google.maps.Marker({
            position: guess_pos,
            label: "GUESS",
            map,
        });
        var bounds = new google.maps.LatLngBounds();
        bounds.extend(actual_pos);
        bounds.extend(guess_pos);
        map.fitBounds(bounds);
        diff_line = new google.maps.Polyline({
            path: [ guess_pos, actual_pos ],
            geodesic: false,
            strokeColor: "#FF0000",
            strokeOpacity: 1.0,
            strokeWeight: 4,
        });
        diff_line.setMap(map);
        pollGame();
      }
    </script>
  </head>
  <body>
    <div id="map"></div>
    <div id="results">
      Distance: {{result.distance | round}}km.<br/>Not bad! You got {{result.points_gained}} points, now you have {{result.new_points}} points.
    </div>
    <div id="next">
      <form action="advance-guess">
        <input style="width:400px" class="btn btn-warning" type="submit" value="{%if locations_remaining == 0 %}End Game{%else%}Continue{%endif%}">
      </form>
    </div>
  </body>
</html>
